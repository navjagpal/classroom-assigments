<html>
  <head>
    <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>

    <script>
			var data = undefined;
			var featureValues = undefined;

			function readSingleFile(e) {
				var file = e.target.files[0];
				if (!file) {
					return;
				}
				Papa.parse(file, {
					header: true,
					complete: function(results) {
						featureValues = {};
						data = results.data;
						console.log(results.data);
						var select = document.getElementById("columns");
						for (const x of Object.keys(results.data[0])) {
							var el = document.createElement("input");
							el.type = "checkbox";
							el.name = "column";
							el.value = x;
							el.id = "column-" + x;
							el.value = x;
							var label = document.createElement("label");
							label.htmlFor = el.id;
							label.appendChild(document.createTextNode(x));
							select.appendChild(el);
							select.appendChild(label);
						}
					}
				});
			}

			function submit() {
				console.log("Send to RPC service");
			}

			function generate() {
				if (document.getElementsByName("feature").length >= 1) {
					return submit();
				}
				console.log("Features size: " + document.getElementsByName("feature").length);
				var features = {};
				var checkboxes = document.getElementsByName("column");
				for (const checkbox of checkboxes) {
					if (checkbox.checked) {
						features[checkbox.value] = new Set();
					}
				}
				for (const row of data) {
					for (const feature of Object.keys(features)) {
						features[feature].add(row[feature].trim());
					}
				}
				featureValues = {};
				for (const feature of Object.keys(features)) {
					// Size == 1 => bad column?
					if (features[feature].size == 2) {
						featureValues[feature] = {
							"Column": feature,
							"Value": features[feature].values().next().value,
						};
					} else if (features[feature].size > 2) {
						for (const value of features[feature].values()) {
							featureValues[feature + "_" + value] = {
								"Column": feature,
								"Value": value
							};
						}
					}
				}
				console.log(featureValues);
				var select = document.getElementById("features");
				for (const feature of Object.keys(featureValues)) {
					var checkbox = document.createElement("input");
					checkbox.type = "checkbox";
					checkbox.name = "feature";
					checkbox.value = feature;
					checkbox.id = "feature-" + feature;
					var label = document.createElement("label");
					label.htmlFor = checkbox.id;
					label.appendChild(document.createTextNode(feature));
					select.appendChild(checkbox);
					select.appendChild(label);
				}
			}

			document.getElementById('file-input')
				.addEventListener('change', readSingleFile, false);
    </script>
  </head>
  <body>

    <input type="file" id="file-input"/>
    
		<fieldset id="columns">
      <legend>Columns</legend>  
    </fieldset>

    <fieldset id="features">
      <legend>Features</legend>  
    </fieldset>

    <button onclick="generate()">Generate Assignments</button>

  </body>
</html>
