<!DOCTYPE html>
<html>
  <head>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.0.3/css/font-awesome.css"> 
  <link rel="stylesheet" href=
  "https://unpkg.com/gridjs/dist/theme/mermaid.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
  <script src=
  "https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>
  <script src="https://unpkg.com/gridjs/dist/gridjs.umd.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
  <style>
* {
    margin: 0;
    padding: 0;
}

html {
    height: 100%;
}

p {
  color: grey;
}

#heading {
  text-transform: uppercase;
  color: #673AB7;
  font-weight: normal;
}

#msform {
    text-align: center;
    position: relative;
    margin-top: 20px;
}

#msform fieldset {
    background: white;
    border: 0 none;
    border-radius: 0.5rem;
    box-sizing: border-box;
    width: 100%;
    margin: 0;
    padding-bottom: 20px;

    /*stacking fieldsets above each other*/
    position: relative;
}

.form-card {
  text-align: left;
}

/*Hide all except first fieldset*/
#msform fieldset:not(:first-of-type) {
    display: none;
}

#msform .stacked {
    padding: 8px 15px 8px 15px;
    border: 1px solid #ccc;
    border-radius: 0px;
    margin-bottom: 25px;
    margin-top: 2px;
    width: 100%;
    box-sizing: border-box;
    font-family: montserrat;
    color: #2C3E50;
    background-color: #ECEFF1;
    font-size: 16px;
    letter-spacing: 1px;
}

#msform input:focus  {
    -moz-box-shadow: none !important;
    -webkit-box-shadow: none !important;
    box-shadow: none !important;
    border: 1px solid #673AB7;
    outline-width: 0;
}

/*Next Buttons*/
#msform .action-button {
    width: 100px;
    background: #673AB7;
    font-weight: bold;
    color: white;
    border: 0 none;
    border-radius: 0px;
    cursor: pointer;
    padding: 10px 5px;
    margin: 10px 0px 10px 5px;
    float: right;
}

#msform .action-button:hover, #msform .action-button:focus {
    background-color: #311B92;
}

/*Previous Buttons*/
#msform .action-button-previous {
    width: 100px;
    background: #616161;
    font-weight: bold;
    color: white;
    border: 0 none;
    border-radius: 0px;
    cursor: pointer;
    padding: 10px 5px;
    margin: 10px 5px 10px 0px;
    float: right;
}

#msform .action-button-previous:hover, #msform .action-button-previous:focus {
    background-color: #000000;
}

/*The background card*/
.card {
    z-index: 0;
    border: none;
    position: relative;
}

/*FieldSet headings*/
.fs-title {
    font-size: 25px;
    color: #673AB7;
    margin-bottom: 15px;
    font-weight: normal;
    text-align: left;
}

.purple-text {
  color: #673AB7;
    font-weight: normal;
}

/*Step Count*/
.steps {
  font-size: 25px;
    color: gray;
    margin-bottom: 10px;
    font-weight: normal;
    text-align: right;
}

/*Field names*/
.fieldlabels {
  color: gray;
  text-align: left;
}

/*Icon progressbar*/
#progressbar {
    margin-bottom: 30px;
    overflow: hidden;
    color: lightgrey;
}

#progressbar .active {
    color: #673AB7;
}

#progressbar li {
    list-style-type: none;
    font-size: 15px;
    width: 25%;
    float: left;
    position: relative;
    font-weight: 400;
}

/*Icons in the ProgressBar*/
#progressbar #students:before {
    font-family: FontAwesome;
    content: "\f183";
}

#progressbar #columns-icon:before {
    font-family: FontAwesome;
    content: "\f0db";
}

#progressbar #features-icon:before {
    font-family: FontAwesome;
    content: "\f0c9";
}

#progressbar #assignments:before {
    font-family: FontAwesome;
    content: "\f00c";
}

/*Icon ProgressBar before any progress*/
#progressbar li:before {
    width: 50px;
    height: 50px;
    line-height: 45px;
    display: block;
    font-size: 20px;
    color: #ffffff;
    background: lightgray;
    border-radius: 50%;
    margin: 0 auto 10px auto;
    padding: 2px;
}

/*ProgressBar connectors*/
#progressbar li:after {
    content: '';
    width: 100%;
    height: 2px;
    background: lightgray;
    position: absolute;
    left: 0;
    top: 25px;
    z-index: -1;
}

/*Color number of the step and the connector before it*/
#progressbar li.active:before, #progressbar li.active:after {
    background: #673AB7;
}

/*Animated Progress Bar*/
.progress {
  height: 20px;
}

.progress-bar {
  background-color: #673AB7;
}

/*Fit image in bootstrap div*/
.fit-image{
    width: 100%;
    object-fit: cover;
}
  </style>
  <script type="text/javascript">
$(document).ready(function(){
    
var current_fs, next_fs, previous_fs; //fieldsets
var opacity;
var current = 1;
var steps = $("fieldset").length;

setProgressBar(current);

$(".next").click(function(){
    
    current_fs = $(this).parent();
    next_fs = $(this).parent().next();
    
    //Add Class Active
    $("#progressbar li").eq($("fieldset").index(next_fs)).addClass("active");
    
    //show the next fieldset
    next_fs.show(); 
    //hide the current fieldset with style
    current_fs.animate({opacity: 0}, {
        step: function(now) {
            // for making fielset appear animation
            opacity = 1 - now;

            current_fs.css({
                'display': 'none',
                'position': 'relative'
            });
            next_fs.css({'opacity': opacity});
        }, 
        duration: 500
    });
    setProgressBar(++current);
});

$(".previous").click(function(){
    
    current_fs = $(this).parent();
    previous_fs = $(this).parent().prev();
    
    //Remove class active
    $("#progressbar li").eq($("fieldset").index(current_fs)).removeClass("active");
    
    //show the previous fieldset
    previous_fs.show();

    //hide the current fieldset with style
    current_fs.animate({opacity: 0}, {
        step: function(now) {
            // for making fielset appear animation
            opacity = 1 - now;

            current_fs.css({
                'display': 'none',
                'position': 'relative'
            });
            previous_fs.css({'opacity': opacity});
        }, 
        duration: 500
    });
    setProgressBar(--current);
});

function setProgressBar(curStep){
    var percent = parseFloat(100 / steps) * curStep;
    percent = percent.toFixed();
    $(".progress-bar")
      .css("width",percent+"%")   
}

$(".submit").click(function(){
    submit();
    return true;
})
    
});
  </script>
  <script>
        var data = undefined;
        var featureValues = undefined;

        function readSingleFile(e) {
          var file = e.target.files[0];
          if (!file) {
            return;
          }
          Papa.parse(file, {
            header: true,
            complete: function(results) {
              students = {};
              featureValues = {};
              data = results.data;
              console.log(results.data);
              var select = document.getElementById("columns");
              for (const x of Object.keys(results.data[0])) {
                var el = document.createElement("input");
                el.type = "checkbox";
                el.name = "column";
                el.value = x;
                el.id = "column-" + x;
                el.value = x;
                el.addEventListener("click", updateFeatures);
                var label = document.createElement("label");
                label.htmlFor = el.id;
                label.className = "fieldlabels";
                label.appendChild(document.createTextNode(x));
                var div = document.createElement("div");
                div.appendChild(el);
                div.appendChild(label);
                select.appendChild(div);
              }
            }
          });
        }

        function displayStats(assignments) {
          var numClasses = parseInt(document.getElementById("num_classes").value);
          var students = {};
          for (const row of data) {
            students[row["id"]] = row;
          }
          var columns = [...Array(numClasses).keys()].map(x => "Class #" + (x+1));
          columns.unshift("Feature");
          var rows = [];
          for (const feature of Object.keys(featureValues)) {
            var row = [feature];
            for (const classroom of Object.keys(assignments)) {
              var num = 0;
              var column = featureValues[feature]["Column"];
              var value = featureValues[feature]["Value"];
              for (const sid of assignments[classroom]) {
                if (students[sid][column] == value) {
                  num += 1;
                }
              }
              row.push(num);
            }
            rows.push(row);
          }
          new gridjs.Grid({
            columns: columns,
            data: rows
          }).render(document.getElementById("stats"));
        }

        function setDownloadButton(data) {
          var download = document.getElementById("download-button");
          var rows = [["Classroom", "Student"]];
          for (var classroom of Object.keys(data)) {
            data[classroom].forEach(function(value, i) {
              rows.push([classroom, value]);
            });
          }
          download.href = "data:text/plain;charset=UTF-8," + encodeURIComponent(
            Papa.unparse(rows));
          download.download = "assignments.csv";
          download.style.visibility = "visible";
        }

        function submit() {
          var checkboxes = document.getElementsByName("feature");
          var selectedFeatures = {};
          for (const checkbox of checkboxes) {
            selectedFeatures[checkbox.value] = featureValues[checkbox.value];
          }
          var numClasses = parseInt(document.getElementById("num_classes").value);
          document.getElementById("loading").style.visibility = "visible";
          $.ajax({
            url: "https://generate-assignments-6ughy77jeq-ue.a.run.app",
            dataType: "json",
            type: "post",
            contentType: "application/json",
            data: JSON.stringify({
              "feature_values": selectedFeatures,
              num_classes: numClasses,
              students: data
            }),
            success: function(data, textStatus, jqxhr) {
              document.getElementById("loading").style.visibility = "hidden";
              setDownloadButton(data);
              var rows = [];
              for (var classroom of Object.keys(data)) {
                data[classroom].forEach(function(value, i) {
                  if (rows.length < i+1) {
                    rows.push([]);
                  }
                  rows[i].push(value);
                });  
              }
              new gridjs.Grid({
                columns: [...Array(numClasses).keys()].map(x => "Class #" + (x+1)),
                data: rows
              }).render(document.getElementById("results"));
              displayStats(data);
            },
            error: function(jqXHR, textStatus, errorThrown) {
              console.log(errorThrown);
              if (jqXHR.status == 400) {
                var errorJson = JSON.parse(jqXHR.responseText);
                alert("Bad input:" + errorJson["error"]);
              } else {
                alert("Unexpected error:" + jqXHR.responseText);
              }
            }
          });
        }

        function updateFeatures() {
          console.log("Features size: " + document.getElementsByName("feature").length);
          var features = {};
          var checkboxes = document.getElementsByName("column");
          for (const checkbox of checkboxes) {
            if (checkbox.checked) {
              features[checkbox.value] = new Set();
            }
          }
          for (const row of data) {
            for (const feature of Object.keys(features)) {
              features[feature].add(row[feature].trim());
            }
          }
          featureValues = {};
          for (const feature of Object.keys(features)) {
            // Size == 1 => bad column?
            if (features[feature].size == 2) {
              featureValues[feature] = {
                "Column": feature,
                "Value": features[feature].values().next().value,
              };
            } else if (features[feature].size > 2) {
              for (const value of features[feature].values()) {
                featureValues[feature + "_" + value] = {
                  "Column": feature,
                  "Value": value
                };
              }
            }
          }
          console.log(featureValues);
          var select = document.getElementById("features");
          select.innerHTML = "";
          for (const feature of Object.keys(featureValues)) {
            var checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.name = "feature";
            checkbox.value = feature;
            checkbox.id = "feature-" + feature;
            checkbox.checked = true;
            var label = document.createElement("label");
            label.htmlFor = checkbox.id;
            label.appendChild(document.createTextNode(feature));
            var div = document.createElement("div");
            div.appendChild(checkbox);
            div.appendChild(label);
            select.appendChild(div);
          }
        }

        document.addEventListener("DOMContentLoaded", () => {
          document.getElementById('file-input')
            .addEventListener('change', readSingleFile, false);
        });
  </script>
  </head>
<body>
<div class="container-fluid">
  <div class="row justify-content-center">
    <div class="col-11 col-sm-9 text-center p-0 mt-3 mb-2">
      <div class="card px-0 pt-4 pb-0 mt-3 mb-3">
        <h2 id="heading">Classroom Assignments</h2>

        <form id="msform">
            <!-- progressbar -->
            <ul id="progressbar">
              <li class="active" id="students"><strong>Students File</strong></li>
              <li id="columns-icon"><strong>Columns</strong></li>
              <li id="features-icon"><strong>Features</strong></li>
              <li id="assignments"><strong>Assignments</strong></li>
            </ul>
            <div class="progress">
              <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
            <br>
            <!-- fieldsets -->
            <fieldset>
              <div class="form-card">
                <div class="row">
                <div class="col-7">
                    <h2 class="fs-title">Student Upload</h2>
                  </div>
                  <div class="col-7">
                    <p>Upload a CSV file which has a row for each student, and columns for each characteristic you want to use for assigning to classrooms. The file must contain a column called "id" which must be a unique identifier for each student. Optionally, you can include a header called "Classroom" if you want to assign some students to specific classrooms manually.</p>
                  </div>
                  <div class="col-5">
                    <h2 class="steps">Step 1</h2>
                  </div>
                </div>
                <input type="file" id="file-input" accept=".csv" class="stacked">
                <label class="fieldlabels">Number of classes</label>
                <input type="text" id="num_classes" class="stacked" value="10"/>
              </div>
              <input type="button" name="next" class="next action-button" value="Next"/>
            </fieldset>
            <fieldset>
              <div class="form-card">
                <div class="row">
                <div class="col-7">
                    <h2 class="fs-title">Columns</h2>
                  </div>
                  <div class="col-5">
                    <h2 class="steps">Step 2 - 4</h2>
                  </div>
                </div>
                <div id="columns"></div>
              </div>
              <input type="button" name="next" class="next action-button" value="Next"/>
              <input type="button" name="previous" class="previous action-button-previous" value="Previous"/>
            </fieldset>
            <fieldset>
              <div class="form-card">
                <div class="row">
                <div class="col-7">
                    <h2 class="fs-title">Features</h2>
                  </div>
                  <div class="col-5">
                    <h2 class="steps">Step 3</h2>
                  </div>
                </div>
                <div id="features"></div>
              </div>
              <input type="button" name="next" class="next submit action-button" value="Submit"/>
              <input type="button" name="previous" class="previous action-button-previous" value="Previous"/>
            </fieldset>
            <fieldset>
              <div class="form-card">
                <div class="row">
                  <div class="col-7">
                    <h2 class="fs-title">Assignments</h2>
                   </div>
                   <div id="loading" style="visibility: hidden;" class="spinner-border" role="status"></div>
                   <a id="download-button" target="_blank" style="visibility: hidden;">Download</a>
                   <div id="results"></div>
                   <div id="stats"></div>
                </div>
              </div>
            </fieldset>
        </form>
      </div>
    </div>
  </div>
</div>
</body>
</html>
